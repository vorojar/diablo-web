# CLAUDE.md

此文件为 Claude Code (claude.ai/code) 在此仓库中工作时提供指导。

## 项目概述

**暗黑破坏神 Web版** 是一款受暗黑破坏神2启发的浏览器ARPG游戏，完全使用原生JavaScript、HTML5 Canvas和CSS3构建。本项目采用**Vibe Coding**开发方法（AI驱动开发，不逐行阅读代码），使用Gemini 3.0 Pro和Claude Code完成。

**核心技术栈：**
- 纯原生 JavaScript (ES6+) - 无任何外部库或框架
- HTML5 Canvas API 用于渲染
- IndexedDB 用于持久化存储
- CSS3 用于UI布局

## 项目结构

这是一个**单文件架构**：
- `index.html` - 主入口，包含HTML结构（面板、UI元素）
- `game.js` - 所有游戏逻辑（约3735行）
- `style.css` - 所有样式
- `bg.mp3` - 背景音乐
- 辅助文档：`README.md`、`task.md`、`人物清单.md`

**重要提示**：游戏无需构建流程，直接在浏览器中打开`index.html`即可运行。

## 代码架构

### 核心系统（game.js）

1. **面板管理系统** (`panelManager`，第1-63行)
   - 管理UI面板（属性、物品栏、技能、任务、商店、成就、仓库）
   - 分组：left（属性、成就、任务）、right（物品栏、仓库）、center（技能、商店）
   - 使用`calculatePosition()`动态定位和堆叠面板
   - 通过`bringToFront()`管理Z轴层级

2. **玩家对象** (第132-166行)
   - 核心状态容器：位置、属性、装备、物品栏、任务、成就
   - 装备槽位：mainhand（主手）、offhand（副手）、body（身体）、helm（头盔）、gloves（手套）、boots（鞋子）、belt（腰带）、ring（戒指）、amulet（项链）
   - 技能：fireball（火球术）、thunder（雷电术）、multishot（多重射击）
   - 抗性：fire（火焰）、cold（冰霜）、lightning（闪电）、poison（毒素），上限75%，下限-100%
   - 难度系统：`isInHell`、`hellFloor`（独立于普通地牢）
   - Boss刷新追踪：`bossRespawn`对象

3. **地图生成** (`generateMap()`函数)
   - 使用元胞自动机的程序化地牢生成
   - 两种地图类型：城镇（`player.floor === 0`）和地牢（`player.floor >= 1`）
   - 出入口坐标存储在`dungeonExit`、`dungeonEntrance`
   - `mapData[][]` - 二维数组（0=地板，1=墙壁）
   - `visitedMap[][]` - 战争迷雾追踪

4. **敌人系统** (第2206-2270行刷新逻辑)
   - 类型：melee（近战沉沦魔）、ranged（远程骷髅弓箭手）、shaman（复活型巫师）、boss（首领）
   - AI行为：chase（追击）、ranged（远程）、revive（复活）
   - 精英词缀系统（`ELITE_AFFIXES`）：12种特殊能力（火焰强化、石肤、吸血等）
   - 基于帧的精灵图：`MONSTER_FRAMES`将类型映射到精灵索引
   - 任务Boss：血鸟（第2层）、女伯爵（第4层）、屠夫（第5层）、树头木拳（第7层）、暗黑破坏神（第9层）、巴尔（第10层）

5. **物品与战利品系统** (`generateItem()`函数)
   - 稀有度等级：0=白色（普通）、2=蓝色（魔法）、3=黄色（稀有）、4=金色（暗金）
   - 词缀系统：前缀+后缀组合（40+种词缀）
   - 装备需求：等级、力量（str）、敏捷（dex）
   - 物品类型：weapon（武器）、body（盔甲）、helm（头盔）、gloves（手套）、boots（鞋子）、belt（腰带）、ring（戒指）、amulet（项链）、offhand（副手）、potion（药水）、scroll（卷轴）
   - 提示框显示本地化的中文属性

6. **伤害系统** (`takeDamage()`，第2272-2376行)
   - 同时支持旧版（数字）和新版（对象）伤害格式
   - 物理伤害：受护甲减免
   - 元素伤害：火焰、冰霜、闪电、毒素（受抗性影响）
   - 精英词缀修改伤害：`magicResist`（70%减免）、`damageReduction`（石肤50%）
   - 死亡触发：任务进度、成就、战利品掉落

7. **任务系统** (`QUEST_DB`，第104-115行)
   - 10个章节任务（从邪恶洞窟到世界之石要塞）
   - 类型：kill_count（击杀数量）、kill_elite（击杀精英）、kill_boss（击杀Boss）
   - 任务状态：0=未开始，1=进行中，2=可交付
   - 进度追踪：`player.questProgress`、`player.questState`

8. **成就系统** (`ACHIEVEMENTS`数组)
   - 6个成就：击杀类、探索类、收集类、挑战类、成长类
   - 通过`trackAchievement()`函数实时追踪
   - 持久化存储在`player.achievements`

9. **难度系统** (第2022-2105行)
   - 普通模式：1-10层
   - 地狱模式：独立的1-10层，击败巴尔后解锁
   - 地狱倍率：HP×6、伤害×4、速度×1.3、经验×5、掉落品质×3.5、所有抗性-100%
   - NPC"地狱守卫"用于在两种模式间切换
   - 死亡自动重置为普通模式

10. **存档系统** (IndexedDB)
    - 每30秒自动保存
    - 存储完整的玩家状态、地图数据、敌人、物品
    - 使用`loadGame()`和`saveGame()`函数

## 核心游戏机制

### 战斗
- **物理攻击**：点击敌人进行攻击（基于冷却时间）
- **技能**：Q（火球术）、W（雷电术）、E（多重射击）
- **射程限制**：所有技能都有最大射程，防止远程狙击Boss
- **墙壁碰撞**：视线检查防止穿墙攻击

### 装备
- **需求系统**：必须满足等级/力量/敏捷才能装备物品
- **词缀叠加**：蓝色以上物品有随机词缀影响属性
- **抗性**：对生存至关重要，特别是在地狱模式
- **物品品质颜色**：白色、蓝色、黄色、金色

### 进度
- **升级**：击杀怪物获得经验值，获得属性点
- **技能**：通过任务和升级获得技能点
- **楼层**：深入更深层获得更强敌人和更好战利品
- **地狱模式**：游戏后期难度飙升

## 常见开发任务

### 测试
无测试套件。需要手动测试：
1. 在Chrome/Firefox/Edge中打开`index.html`
2. 使用浏览器开发者工具控制台调试
3. 按`F12`检查IndexedDB中的存档数据

### 调试
- 所有游戏状态在全局`player`对象中
- 使用`console.log()`调试（无日志框架）
- 常见问题：
  - 精灵图加载：检查`spritesLoaded`标志
  - 保存/加载：在开发者工具中检查IndexedDB
  - 性能：使用浏览器性能分析器

### 添加新功能

**添加新的物品词缀：**
1. 添加到`AFFIXES`对象（前缀/后缀）
2. 更新`applyEquipmentStats()`处理新属性
3. 更新物品显示代码中的提示框渲染

**添加新技能：**
1. 添加到`player.skills`对象
2. 在技能执行部分实现技能逻辑
3. 添加UI按钮和快捷键绑定
4. 添加到技能树面板

**添加新怪物：**
1. 添加到`spawnEnemyTimer()`中的刷新逻辑
2. 定义AI行为
3. 添加精灵帧到`MONSTER_FRAMES`
4. 配置HP/伤害缩放公式

**添加新任务：**
1. 添加条目到`QUEST_DB`数组
2. 在`takeDamage()`中更新任务追踪逻辑
3. 在任务完成处理器中定义奖励

## 关键约束

1. **禁止外部依赖** - 仅使用纯原生JS
2. **单文件逻辑** - 所有游戏代码在game.js中（无模块化）
3. **基于Canvas渲染** - 所有视觉效果通过Canvas API
4. **浏览器兼容性** - 必须在现代浏览器中运行（ES6+）
5. **中文本地化** - 所有UI文本使用中文

## 诊断问题

当前TypeScript诊断（非阻塞，仅供参考）：
- 第1863行：未使用的变量`i`（循环中）
- 第2503行：未使用的变量`radius`

这些非关键问题，可以通过删除未使用的声明来解决。

## 开发理念

本项目遵循**Vibe Coding**原则：
- AI驱动开发
- 最小化手动代码阅读
- 迭代式功能添加
- 注重可玩性而非代码完美性

进行修改时：
- 保持单文件架构
- 保持原生JS（不使用框架）
- 保留中文UI文本
- 每次修改后在浏览器中测试
- 考虑与现有存档数据的向后兼容性

## 版本历史要点

- **v1.0-1.4**：核心引擎、战斗、UI、任务、音频
- **v1.5**：仓库系统、右键丢弃、技能反馈
- **v1.6**：音效改进、技能射程限制、怪物名称显示
- **v1.7**：成就系统、仓库UI位置修复
- **v1.8**：自动走向物品、本地化、Boss平衡、浮动文字系统
- **v2.0**：抗性系统、装备需求、精英词缀（40+词缀）
- **v2.1**：地狱模式、双地图系统、地狱守卫NPC
- **v2.2**：Boss刷新（5分钟冷却）、成就修复
- **v2.3**：雷电术替换冰霜新星

## 重要文件位置

- 游戏入口：`index.html:46`（开始按钮）
- 主游戏循环：`game.js`（搜索`requestAnimationFrame`）
- 玩家属性计算：搜索`calculatePlayerStats()`
- 物品生成：搜索`generateItem()`
- 地图生成：搜索`generateMap()`或`generateDungeon()`
- 保存/加载：搜索`saveGame()`和`loadGame()`
- 面板管理：`game.js:1-63`（panelManager对象）

## 参考文档

- `README.md` - 完整的游戏功能和操作文档
- `task.md` - 计划功能路线图（套装系统、符文系统等）
- `人物清单.md` - 角色名册（NPC、怪物、Boss）

## 未来开发方向（参考task.md）

优先级最高的待实现功能：
1. **套装系统**（绿装） - 收集套装获得额外加成
2. **符文与镶嵌系统** - 符文之语让普通装备也有价值
3. **更深的技能树** - 每个元素系扩展到多个技能
4. **传送点系统** - 减少重复跑路
5. **可破坏物品和箱子** - 增加探索乐趣
6. **更多怪物种类** - 不同AI和战斗模式
7. **Boss技能和阶段系统** - 让Boss战更有挑战性

所有功能设计细节请参考`task.md`中的完整说明。
